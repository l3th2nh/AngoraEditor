        <style>
        body{
			margin:0px;
			padding:0px;
        }
        #map{
			height:528px;
			width:528px;        
			float:left;
			overflow:scroll;
        }
        #layer{
			height:264px;
			width:264px;
			float:left;
			overflow:scroll;
        }
		.layer{
			height:24px;
			border:1px solid black;
		}
		.layer.selected{
			border:1px solid red;
		}
        #tilesets{
			padding: 0;
			margin: 0;
        }
		#tiles{
			height:264px;
			width:264px;
			float:left;
			overflow:scroll;
		}
		#marker{
			position:relative;
			left:0px;
			top:0px;
			border:1px red solid;
			height:32px;
			width:32px;
		}
		#tilemapdiv{
			float:left;
		}
        </style>
    <div class="easyui-layout" fit="true">
        <div data-options="region:'south'" style="overflow:hidden">
		    <button id="btn_ok" style="float:left;margin-top:10px;">OK</button>
			<button id="btn_cancel" style="float:right;margin-top:10px;">Cancel</button>
        </div>
        <div id="map" data-options="region:'center'">
		    <div id="tilemapdiv"></div>
        </div> 
        <div id="leftContainer" data-options="region:'east',split:true" title="Scene" style="width:300px;">
            <div class="easyui-layout" fit="true">
                <div data-options="region:'north'" style="overflow:hidden">
					<a id="btn" href="#" class="easyui-linkbutton" data-options="iconCls:'icon-add'"></a>
				</div>
                <div id="layer" data-options="region:'center'"></div>
                <div id="tiles" data-options="region:'south'">
					<div id="tilesets"></div>
					<div id="marker"></div>
                </div>
            </div>
        </div>
    </div>
	<script>
	$(document).ready(function () {
		var editor=edt;
		if(editor.node.selected==null){
			$('#dd').dialog('close');
			return false;
		}
		var mymarker=document.getElementById("marker");
		var tiles=document.getElementById("tiles");
		var tilesets=document.getElementById('tilesets');
		var pos = [0, 0];
		var tileid = { x: 0, y: 0 };
		var tileRect = null;
		var mapPath=editor.project.currentProject.path+"/"+editor.res.get(editor.node.selected.tilemap).data;//"/data/features_test.json";
		var mapObject;
		var mapLayers;
		var mapTileSets;
		
		var map;
		var marker;
		var currentTile = 2;
		var currentLayer;
		var cursors;
		var selectedTab;
		var tilerows=0;
		var tilecols=0;
		var tilestart=0;
		var currenttileimg=null;

		var mouseDown = false;

		$("#tiles").on({
			mousemove: function (e) {
				pos[0] = e.clientX;//+tiles.scrollLeft;
				pos[1] = e.clientY;//+tiles.scrollTop;
			}
		});
		$('#tiles').delegate('img','mouseenter',function(){
			for(i in mapTileSets){
				if(mapTileSets[i].name==$(this).attr('id')){
					mymarker.style.height=mapTileSets[i].tileheight+'px';
					mymarker.style.width=mapTileSets[i].tilewidth+'px';
					tilerows=mapTileSets[i].imageheight/mapTileSets[i].tileheight;
					tilecols=mapTileSets[i].imagewidth/mapTileSets[i].tilewidth;
					tilestart=mapTileSets[i].firstgid;
					currenttileimg=$(this);
				}
			}
		});
		$("#marker").on({
			click: function (e) {
				currentTile = tileid.y * tilecols + tileid.x + tilestart;
			}
		});
		editor.file.readFile(mapPath, function(json) {
			mapObject=JSON.parse(json);
			mapLayers=mapObject['layers'];
			mapTileSets=mapObject['tilesets'];
			for( i in mapLayers){
				$('#layer').append("<div class='layer'>"+mapLayers[i].name+"</div>");
			}
			/*for( i in mapTileSets){
				$('#tilesets').append('<img id="'+mapTileSets[i].name+'" src="data/'+mapTileSets[i].image+'"/>');
			}*/
			$('.layer').on('click',function(){
				var selected=$(".layer.selected");
				if(selected.length>0)
					selected.removeClass("selected");
				$(this).addClass("selected");
				var layername=$(this).innerHTML;
				map.createLayer('Tile Layer 3');
				layer = map.createLayer('Tile Layer 1');
				layer.resizeWorld();
				currentLayer = layer;
			});
			
			var game = new Phaser.Game(mapObject.tilewidth*mapObject.width, mapObject.tileheight*mapObject.height, Phaser.CANVAS, 'tilemapdiv', { preload: preload, create: create, update: update });

			function preload() {
				for(i in mapTileSets){
					var key=mapTileSets[i].name;
					var imgsrc=editor.project.currentProject.path+"/"+editor.res.get(editor.node.selected.tilemap).tileset[key];
					game.load.image(mapTileSets[i].name, imgsrc);
					$('#tilesets').append('<img id="'+mapTileSets[i].name+'" src="'+imgsrc+'"/>');
				}
				game.load.tilemap('map', mapPath, null, Phaser.Tilemap.TILED_JSON);
			}
			
			function create() {
				map = game.add.tilemap('map');
				
				for(i in mapTileSets){
					map.addTilesetImage(mapTileSets[i].name);
				}

				//map.createLayer('Tile Layer 3');
				layer = map.createLayer('Tile Layer 1');

				layer.resizeWorld();

				currentLayer = layer;
				
				//  Our painting marker
				marker = game.add.graphics();
				marker.lineStyle(2, 0x000000, 1);
				marker.drawRect(0, 0, 32, 32);
				game.input.setMoveCallback(updateMarker, this);

				cursors = game.input.keyboard.createCursorKeys();

			}

			function updateMarker() {
				marker.x = currentLayer.getTileX(game.input.activePointer.worldX) * 32;
				marker.y = currentLayer.getTileY(game.input.activePointer.worldY) * 32;
				if (game.input.mousePointer.isDown){
					var offsetx=currentLayer.getTileX(marker.x);
					var offsety=currentLayer.getTileY(marker.y);
					map.putTile(currentTile, offsetx, offsety, currentLayer);
					mapObject.layers[map.currentLayer].data[offsety*mapObject.width+offsetx]=currentTile;
				}
			}
			function update() {
				//console.log(pos[0],pos[1],tileRect.width,tileRect.height);
				tileRect=$("#tilesets").offset();
				var h=mymarker.clientHeight;
				var w=mymarker.clientWidth;
				var mtop=tileRect.top;
				if(currenttileimg!=null)
					mtop=currenttileimg.offset().top;
				tileid.x = game.math.snapToFloor(pos[0] - tileRect.left, w) / w;
				tileid.y = game.math.snapToFloor(pos[1] - mtop, h) / h;
				//console.log(tileid);
				mymarker.style.left = game.math.snapToFloor(pos[0] - tileRect.left, w)+  'px';
				mymarker.style.top = game.math.snapToFloor(pos[1] - tilesets.clientHeight - tileRect.top, h) - 1 + 'px';
			}
		});	
		$("#btn_ok").click(function(){
			var canvas = document.getElementById('tilemapdiv').children[0];
			editor.ui.gamePane.update(editor.node.selected,'mapcache',canvas.toDataURL());
			editor.file.writeFile(mapPath,JSON.stringify(mapObject));
			$('#dd').dialog('close');
		});
	});
	</script>
